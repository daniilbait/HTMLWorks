<!DOCTYPE html>
<html lang="ru">
  <head>
    <!--Подключение Bootstrap 5-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous" />
    <!--Подключение Slick Slider CSS-->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick-theme.css" />
    <!--Подключение библиотек для JS-->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js"></script>
    <!--Задаем изменение размера пикселей для телефонов-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <title>Лаборатная работа 8</title>
  </head>

  <body class="container-lg m-auto p-0">
    <div class="all d-flex flex-row flex-wrap justify-content-center w-100">
      <header class="container-fluid">
        <!-- Шапка -->
        <div class="row align-items-center align-items-sm-start">
          <div class="order-sm-0 col-3 col-sm-2">
            <img alt="логотип" class="logo w-100 ms-1 mb-2" src="logo.jpg" />
          </div>
          <div class="order-sm-2 col-9 col-sm-12 m-sm-1">
            <h1 class="text-end text-wrap">
              Разработка пользовательского WEB-интерфейса
            </h1>
          </div>
          <div class="order-sm-1 col-12 col-sm-10">
            <nav
              class="d-flex flex-column flex-sm-row flex-sm-nowrap align-items-center mb-1"
            >
              <a
                class="nav-btn order-1 order-sm-1 my-1 flex-sm-grow-1"
                id="nav1"
                href="#hyperpages"
                >Гиперссылки</a
              >
              <a
                class="nav-btn order-0 order-sm-1 my-1 flex-sm-grow-1 mx-sm-1"
                id="nav2"
                href="#table"
                >Таблица</a
              >
            </nav>
          </div>
        </div>
      </header>
      <!-- Шапка -->
      <div class="main d-flex flex-column flex-nowrap justify-content-between">
        <div id="hyperpages" class="order-1 order-sm-1 mx-1 mt-1 m-lg-3">
          <!-- Гиперссылки -->
          <h2 class="ms-2 mt-1">Гиперссылки:</h2>
          <ul class="ms-2">
            <li>
              <a href="http://kubsu.ru/">1. Главная страница сайта КубГУ</a>
            </li>
            <li>
              <a href="https://kubsu.ru/"
                >2. Главная страница сайта КубГУ (в протоколе https)</a
              >
            </li>
            <li>
              <a href="https://github.com"
                >3.<img alt="Изображение-ссылка" src="image1.jpg"
              /></a>
            </li>
            <li>
              <a href="/HTMLWorks2/Fourth.html">4. На внутреннюю страницу</a>
            </li>
            <li><a href="/HTMLWorks2">5. На главную страницу</a></li>
            <li>
              <a href="#start">6. Перейти к заголовку данн ой страницы</a>
            </li>
            <li>
              <a
                href="https://www.wildberries.ru/catalog/dom/osveshchenie/nochniki?sort=popular&page=1&fcolor=16119260"
                >7. Поиск с тремя параметрами</a
              >
            </li>
            <li><a href="Ninth.html">9. Страница в текущем каталоге</a></li>
            <li>
              <a href="/about/Tenth.html">10. Страница в каталоге about</a>
            </li>
            <li>
              <span>
                13. В последнее время студенты часто стали жаловаться на
                отсутствие мобильного интернета по вечерам. Взамен нестабильному
                мобильному сигналу проживающие в общежитии, а также посетители
                основного здания ВУЗа могут по следующей
                <a
                  href="https://www.kubsu.ru/sites/default/files/insert/page/instrukciya_po_podklyucheniyu_k_seti_wifi_v_windows10.pdf"
                  >инструкции</a
                >
                подключиться к точки доступа wi-fi на ПК или ноутбуках.</span
              >
            </li>
            <li>
              <a href="https://ru.wikipedia.org/wiki/Linux#Критическая_кампания"
                >14. Ссылка на фрагмент страницы стороннего сайта</a
              >
            </li>
            <li><a href="">16. Тут пусто</a></li>
            <li><a>17. А тут вообще ничего нет</a></li>
            <li>
              <a href="index.html" rel="nofollow"
                >18. Фармить криптовалюту можно здесь</a
              >
            </li>
            <li>
              <a href="index.html" rel="noindex">19. Оформить загранпаспорт</a>
            </li>
          </ul>
        </div>
        <!-- Гиперссылки -->
        <table
          id="table"
          class="order-sm-1 mx-auto my-3 text-center align-self-center"
        >
          <!-- Таблица -->
          <tr>
            <td colspan="4">Расписание занятий на понедельник</td>
          </tr>
          <tr class="chet">
            <td>Пара</td>
            <td>Время</td>
            <td>МО22/1</td>
            <td>МО22/2</td>
          </tr>
          <tr class="nechet">
            <td rowspan="2">4</td>
            <td rowspan="2">12:40-14:00</td>
            <td>ООП лаб</td>
            <td rowspan="2">Разработка пользовательского WEB интерфейса лаб</td>
          </tr>
          <tr class="nechet">
            <td></td>
          </tr>
          <tr class="chet">
            <td>5</td>
            <td>14:10-15:30</td>
            <td colspan="2">
              Теория вероятностей и математическая статистика лекция
            </td>
          </tr>
          <tr class="nechet">
            <td>6</td>
            <td>15:40-17:00</td>
            <td colspan="2">
              Разработка пользовательского WEB интерфейса лекция
            </td>
          </tr>
          <tr class="chet">
            <td>7</td>
            <td>17:10-18:30</td>
            <td>Математический анализ лаб</td>
            <td></td>
          </tr>
        </table>
        <!-- Таблица -->

        <!-- Кнопка для открытия попапа -->
        <button
          id="openFormBtn"
          class="floating-btn"
          aria-label="Открыть форму обратной связи"
        >
          <img
            src="cloud_message.png"
            alt="Открыть форму"
            class="floating-btn-img"
          />
        </button>

        <div id="formPopup" class="popup">
          <div class="popup-content p-0">
            <button class="popup-close">&times;</button>
            <form id="form" class="d-flex flex-column p-2">
              <h2 class="mb-2 text-center">Форма обратной связи</h2>
              <div class="mb-2"><!-- ФИО -->
                <label for="fullname" class="form-label">ФИО:</label>
                <input
                  class="form-control form-control-sm"
                  type="text"
                  id="fullname"
                  name="fullname"
                  pattern="[A-Za-zА-Яа-яЁё\s]{4,100}"
                  title="Только буквы и пробелы (4-100 символов)"
                  required
                />
              </div>
              <div class="mb-2"><!-- Почта -->
                <label for="email" class="form-label">E-mail:</label>
                <input
                  class="form-control form-control-sm"
                  type="email"
                  id="email"
                  name="email"
                  pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$"
                  title="Введите корректный email"
                  required
                />
              </div>
              <div class="mb-2"><!-- Телефон -->
                <label for="tel" class="form-label">Телефон:</label>
                <input
                  class="form-control form-control-sm"
                  type="tel"
                  id="tel"
                  name="phone"
                  pattern="^\+?[0-9]{10,15}$"
                  title="[+] 10-15 цифр"
                  required
                />
              </div>
              <div class="mb-2"><!-- Компания -->
                <label for="organization" class="form-label"
                  >Организация:</label
                >
                <input
                  class="form-control form-control-sm"
                  type="text"
                  id="organization"
                  name="organization"
                  pattern="[A-Za-zА-Яа-яЁё0-9\s\.,&quot;']{2,100}"
                  title="Только буквы, цифры, точки, запятые и кавычки"
                />
              </div>

              <!-- Сообщение -->
              <div class="mb-2">
                <label for="message" class="form-label">Сообщение:</label>
                <textarea
                  class="form-control form-control-sm"
                  id="message"
                  name="message"
                  rows="3"
                  minlength="10"
                  maxlength="500"
                  title="Сообщение должно быть от 10 до 500 символов"
                  required
                ></textarea>
              </div>
              <div class="mb-2 form-check"><!-- Форма согласия -->
                <input
                  class="form-check-input"
                  type="checkbox"
                  name="agreement"
                  id="agreement"
                  required
                />
                <label class="form-check-label" for="agreement">
                  Согласен(а) с политикой обработки персональных данных
                </label>
              </div>
              <button type="submit" class="btn btn-primary btn-sm">
                Отправить
              </button>
            </form>
          </div>
        </div>
        <div id="notification" class="notification"></div>
      </div>
      <footer class="w-100">
        <!-- Подвал -->
        <p>© Байталенко Даниил, КубГУ, МО22/1</p>
      </footer>
      <!-- Подвал -->
    </div>

    <script>
      const openFormBtn = document.getElementById("openFormBtn");
      const formPopup = document.getElementById("formPopup");
      const popupClose = document.querySelector(".popup-close");
      const form = document.getElementById("form");
      const notification = document.getElementById("notification");
      const formFields = {
        fullname: document.getElementById("fullname"),
        email: document.getElementById("email"),
        phone: document.getElementById("tel"),
        organization: document.getElementById("organization"),
        message: document.getElementById("message"),
        agreement: document.getElementById("agreement"),
      };
      const STORAGE_KEY = "formData";
      const FORM_ENDPOINT = "https://formcarry.com/s/vaL5ZkR9U6F";
      let saveTimeout;
      
      document.addEventListener("DOMContentLoaded", function () {
        restoreFormData();
        setupEventListeners();
      });
      
      function setupEventListeners() {
        openFormBtn.addEventListener("click", openPopup);
        popupClose.addEventListener("click", closePopup);
        formPopup.addEventListener("click", function (e) {
          if (e.target === formPopup) {
            closePopup();
          }
        });
        form.addEventListener("submit", handleFormSubmit);
        Object.values(formFields).forEach((field) => {
          if (field.type === "checkbox") {
            field.addEventListener("change", saveFormDataWithDebounce);
          } else {
            field.addEventListener("input", saveFormDataWithDebounce);
          }
        });
        window.addEventListener("popstate", function (e) {
          if (formPopup.classList.contains("active")) {
            closePopup(false);
          }
        });
        document.addEventListener("keydown", function (e) {
          if (e.key === "Escape" && formPopup.classList.contains("active")) {
            closePopup();
          }
        });
      }
      
      function openPopup() {
        formPopup.classList.add("active");
        document.body.style.overflow = "hidden";
        history.pushState({ formOpen: true }, "", "#form");
      }
      
      function closePopup(updateHistory = true) {
        formPopup.classList.remove("active");
        document.body.style.overflow = "";
        if (updateHistory && history.state && history.state.formOpen) {
          history.back();
        }
      }
      
      function saveFormDataWithDebounce() {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(saveFormData, 500);
      }
      
      function saveFormData() {
        const formData = {};
        Object.keys(formFields).forEach((key) => {
          const field = formFields[key];
          if (field.type === "checkbox") {
            formData[key] = field.checked;
          } else {
            formData[key] = field.value;
          }
        });

        localStorage.setItem(STORAGE_KEY, JSON.stringify(formData));
      }
      
      function restoreFormData() {
        const savedData = localStorage.getItem(STORAGE_KEY);
        if (savedData) {
          try {
            const formData = JSON.parse(savedData);

            Object.keys(formData).forEach((key) => {
              if (formFields[key]) {
                if (formFields[key].type === "checkbox") {
                  formFields[key].checked = formData[key];
                } else {
                  formFields[key].value = formData[key];
                }
              }
            });
          } catch (e) {
            console.error("Ошибка при восстановлении данных формы:", e);
          }
        }
      }

      function clearFormData() {
        localStorage.removeItem(STORAGE_KEY);
      }

      async function handleFormSubmit(e) {
        e.preventDefault();
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }
        const formData = new FormData(form);
        console.log("Отправляемые данные:");
        for (let [key, value] of formData.entries()) {
          console.log(`${key}: ${value}`);
        }
        try {
          const response = await fetch(FORM_ENDPOINT, {
            method: "POST",
            body: formData,
            headers: {
              Accept: "application/json",
            },
          });
          console.log("Статус ответа:", response.status);
          console.log("Ответ сервера:", response);
          const responseText = await response.text();
          console.log("Текст ответа:", responseText);

          if (response.ok) {
            showNotification("Форма успешно отправлена!", "success");
            form.reset();
            clearFormData();
            setTimeout(() => {
              closePopup();
            }, 2000);
          } else {
            throw new Error(
              `Ошибка сервера: ${response.status}. Ответ: ${responseText}`
            );
          }
        } catch (error) {
          console.error("Ошибка при отправке формы:", error);
          showNotification(
            "Произошла ошибка при отправке формы. Попробуйте еще раз.",
            "error"
          );
        }
      }
      function showNotification(message, type) {
        notification.textContent = message;
        notification.className = `notification ${type}`;
        notification.classList.add("show");

        setTimeout(() => {
          notification.classList.remove("show");
        }, 5000);
      }
    </script>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
